name: Auto Merge PR

# on:
#   pull_request:
#     types:
#       - closed

on:
  pull_request:
    types:
      - opened

jobs:
  if_merged:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: TEST
        id: test
        run: |
          source_branch="feature-branch"
          target_branch="main"

          response=$(curl -L -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer 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" \
          -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/repos/free-cutyapple/test/merges \
          -d '{"base":"iok210", "head": "main", "commit_message": "Merge"}')

            echo "$response"

            echo "$response | jq -r '.status'"

            # API 응답에서 병합 결과 확인
            merged=$(echo "$response" | jq -r '.merged')

            if [[ "$merged" == "true" ]]; then
              echo "브랜치 병합 성공"
            else
              echo "브랜치 병합 실패"
            fi

      - name: Check if PR is closed
        id: doing
        run: |
          echo "Run Auto-Merge script."

          BRANCHES=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
          "https://api.github.com/repos/${{ github.repository }}/branches" | jq -r '.[].name')

          PR_NUMBER=$(jq -r '.pull_request.number' < "$GITHUB_EVENT_PATH")
          PR_STATE=$(jq -r '.pull_request.state' < "$GITHUB_EVENT_PATH")
          BRANCH_NAME=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER" | jq -r '.head.ref')
          PREFIX=M2SP-2306-02

          echo "------------------------------------------"

          for BRANCH in $BRANCHES; do
            catch() {
              echo "$BRANCH에서 하자 발생."
              # Slack 메시지 보내기
              # curl -X POST -H 'Content-type: application/json' --data '{"text":"예외가 발생했습니다."}' YOUR_SLACK_WEBHOOK_URL
              # exit 1
              return 0
            }

            # trap 설정
            trap catch ERR

            if [[ $BRANCH == "$PREFIX"* ]]; then

              echo "Merging PR $PR_NUMBER to $BRANCH branch"

              AA=$(curl -L -X POST \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer 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" \
                -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/repos/free-cutyapple/test/merges \
                "https://api.github.com/repos/${{ github.repository }}/merges" \
                -d '{"base":"$BRANCH","head":"main","commit_message":"PLEASE merge main to $BRANCH"}')
              
              echo $AA

              # git config user.name github-actions
              # git config user.email github-actions@github.com
              # git checkout "$BRANCH"
              # echo "Checkout $BRANCH"
              # git merge "$BRANCH_NAME" --no-ff --no-commit
              # git commit -m "Auto-merge PR #$PR_NUMBER to $BRANCH branch"
              # git push origin "$BRANCH"
            fi
          done
