name: Auto Merge PR

on:
  pull_request:
    types:
      - closed
  push:
    branches:
      - main

jobs:
  if_merged:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Merge Main to Branches
        run: |
          echo "Run Auto-Merge script."

          BRANCHES=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
          "https://api.github.com/repos/${{ github.repository }}/branches" | jq -r '.[].name')

          SUCCESS="[]"
          FAILURE="[]"
          CONFLICT="[]"

          for BRANCH in $BRANCHES; do
            catch() {
              echo "$BRANCH에서 하자 발생."
              # curl -H 'Content-type: application/json' \
              #   --data '{"text":"*'"$BRANCH"'*에서 에러가 발생했습니다."}' \
              #   -H "Authorization: Bearer ${{ github.token}}" \
              #   -X POST ${{ secrets.SLACK_FE_AUTO_BOT_WEBHOOK_URL }}
              return 0
            }

            trap catch ERR

            if echo "$BRANCH" | grep -qE '[0-9]{4}-[0-9]{2}-[0-9]{2}'; then
              BRANCH_DATE=$(echo "$BRANCH" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}')
              CURRENT_DATE=$(date +'%Y-%m-%d')

              if [[ "$BRANCH_DATE" > "$CURRENT_DATE" ]]; then
                echo "Merge main to $BRANCH branch"

                MERGE_RESPONSE=$(curl -i -L \
                  -X POST -H "Accept: application/vnd.github+json" \
                  -H "Authorization: Bearer ${{github.token}}" \
                  -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/repos/${{ github.repository }}/merges \
                  -d '{"base":"'"$BRANCH"'", "head": "main", "commit_message": "Merge"}')

                echo $MERGE_RESPONSE
                  
                STATUS_CODE=$(echo "$MERGE_RESPONSE" | grep -o -P '(?<=HTTP/2 )[0-9]+')
                  
                if [ $STATUS_CODE -ge 200 ] && [ $STATUS_CODE -lt 300 ]; then
                  SUCCESS="${SUCCESS::-1}, '${BRANCH}']"
                elif [ $STATUS_CODE == 409 ]; then
                  CONFLICT="${CONFLICT::-1}, '${BRANCH}']"
                else
                  FAILURE="${FAILURE::-1}, '${BRANCH}']"
                fi
              fi
            fi
          done

          echo $SUCCESS
          echo $CONFLICT
          echo $FAILURE

          A=$(node -e "const arrStr = $SUCCESS.slice(1);  console.log(arrStr.join(', '));")
          B=$(node -e "const arrStr = $CONFLICT.slice(1);  console.log(arrStr.join(', '));")
          C=$(node -e "const arrStr = $FAILURE.slice(1);  console.log(arrStr.join(', '));")

          echo $A
          echo $B
          echo $C

          if [ -n "${A}" ]; then
            curl -H 'Content-type: application/json' \
              --data '{"text":"🟢 [SUCCESS] The merge from main to *'"$A"'* was successful."}' \
              -H "Authorization: Bearer ${{ github.token}}" \
              -X POST ${{ secrets.SLACK_FE_AUTO_BOT_WEBHOOK_URL }}            
          fi

          if [ -n "${B}" ]; then
            curl -H 'Content-type: application/json' \
              --data '{"text":"🔴 [MERGE CONFLICT] The merge from main to *'"$B"'* conflicted."}' \
              -H "Authorization: Bearer ${{ github.token}}" \
              -X POST ${{ secrets.SLACK_FE_AUTO_BOT_WEBHOOK_URL }}
          fi

          if [ -n "${C}" ]; then
            curl -H 'Content-type: application/json' \
              --data '{"text":"🔴 [FAILED] The merge from main to *'"$C"'* failed."}' \
              -H "Authorization: Bearer ${{ github.token}}" \
              -X POST ${{ secrets.SLACK_FE_AUTO_BOT_WEBHOOK_URL }}
          fi

          # echo $SUCCESS | jq -r '. | join(",")'
