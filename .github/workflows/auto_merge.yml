name: Auto Merge PR

# on:
#   pull_request:a
#     types:
#       - closed

on:
  pull_request:
    types:
      - opened

jobs:
  if_merged:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Check if PR is closed
        id: doing
        run: |
          echo "Run Auto-Merge script."

          BRANCHES=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
          "https://api.github.com/repos/${{ github.repository }}/branches" | jq -r '.[].name')

          echo $BRANCHES

          PR_NUMBER=$(jq -r '.pull_request.number' < "$GITHUB_EVENT_PATH")
          PR_STATE=$(jq -r '.pull_request.state' < "$GITHUB_EVENT_PATH")
          BRANCH_NAME=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER" | jq -r '.head.ref')
          PREFIX=M2SP-2306-02

          # echo $PR_NUMBER
          # echo $PR_STATE
          echo $BRANCH_NAME
          echo $PREFIX


          for BRANCH in "${BRANCHES[@]}"; do
            echo "$BRANCH - for"
            if [[ $BRANCH == $PREFIX* ]]; then
              echo "Merging PR $PR_NUMBER to $BRANCH branch"
              git config user.name github-actions
              git config user.email github-actions@github.com
              git checkout "$BRANCH"
              echo "Checkout $BRANCH"
              # git merge "$BRANCH_NAME" --no-ff --no-commit
              # git commit -m "Auto-merge PR #$PR_NUMBER to $BRANCH branch"
              # git push origin "$BRANCH"
            fi
            echo "$BRANCH - for END"
          done


          # PR_NUMBER=$(jq -r '.pull_request.number' < "$GITHUB_EVENT_PATH")
          # PR_STATE=$(jq -r '.pull_request.state' < "$GITHUB_EVENT_PATH")
          # BRANCH_NAME=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
          #   "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER" | jq -r '.head.ref')

          #   declare -a DESIRED_BRANCHES=("branch1" "branch2" "branch3")
          #   for DESIRED_BRANCH in "${DESIRED_BRANCHES[@]}"; do
          #     if [ "$PR_STATE" = "closed" ]; then
          #       echo "Merging PR $PR_NUMBER to $DESIRED_BRANCH branch"
          #       git config user.name github-actions
          #       git config user.email github-actions@github.com
          #       git checkout "$DESIRED_BRANCH"
          #       git merge "$BRANCH_NAME" --no-ff --no-commit
          #       git commit -m "Auto-merge PR #$PR_NUMBER to $DESIRED_BRANCH branch"
          #       git push origin "$DESIRED_BRANCH"
          #     fi
          #   done
