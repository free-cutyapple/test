name: Auto Merge PR

# on:
#   pull_request:
#     types:
#       - closed

on:
  pull_request:
    types:
      - opened

jobs:
  if_merged:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Get Branches with Tag
        id: branches_with_tag
        run: |
          echo $(git branch --contains main)

          TAG_NAME="asdf"
          BRANCHES=$(git for-each-ref --format='%(refname:short)' refs/heads/ --contains "refs/tags/$TAG_NAME")
          echo "::set-output name=branches_with_tag::$BRANCHES"

      - name: Display Branches with Tag
        run: |
          echo "Branches with Tag: ${{ steps.branches_with_tag.outputs.branches_with_tag }}"

      - name: Check if PR is closed
        id: doing
        run: |
          echo "Run Auto-Merge script."

          PR_NUMBER=$(jq -r '.pull_request.number' < "$GITHUB_EVENT_PATH")
          PR_STATE=$(jq -r '.pull_request.state' < "$GITHUB_EVENT_PATH")
          BRANCH_NAME=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER" | jq -r '.head.ref')

            # declare -a DESIRED_BRANCHES=("branch1" "branch2" "branch3")
            # for DESIRED_BRANCH in "${DESIRED_BRANCHES[@]}"; do
            #   if [ "$PR_STATE" = "closed" ]; then
            #     echo "Merging PR $PR_NUMBER to $DESIRED_BRANCH branch"
            #     git config user.name github-actions
            #     git config user.email github-actions@github.com
            #     git checkout "$DESIRED_BRANCH"
            #     git merge "$BRANCH_NAME" --no-ff --no-commit
            #     git commit -m "Auto-merge PR #$PR_NUMBER to $DESIRED_BRANCH branch"
            #     git push origin "$DESIRED_BRANCH"
            #   fi
            # done
